<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>藝文活動資訊</title>
    <script src="data.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
        integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="spot.css">
</head>

<body>
    <div class="navbar">
        <div class="selectCategory">
            <div class="word">選擇類別</div>
            <div class="categoryMenu"></div>
        </div>
        <div class="myFavorite">我的最愛</div>
    </div>


    <div class="container">
        <div class="col"></div>
        <div class="col"></div>
        <div class="col"></div>
        <div class="col"></div>
    </div>



    <script>
        var _currentPage = 1;
        var _pageSize = 30;
        var _category = 1;
        var _baseApiUrl = 'https://cloud.culture.tw/frontsite/trans/SearchShowAction.do?method=doFindTypeJ&category=';
        var _isFavoriteMode = false;

        function callAPI() {
            return fetch(_baseApiUrl + _category, {
                method: "GET",
            }).then(result => {
                return result.json();
            }).then((resultList) => {
                return resultList;
            });
        }

        function refreshView() {
            $('.col').empty();
            callAPI().then(result => {
                // console.log(result);
                renderShowList(result);
            });
        }

        function showFavoriteView() {
            $('.col').empty();
            renderShowList(favoriteArray, true);
            
        }


        function renderShowList(spotDataList, isFavorite) {
            var favoriteUIDs =  favoriteArray.map(data=>data.UID);

            spotDataList.forEach((spotData, index) => {
                $('.col').eq(index % 4).append(
                    renderCard(spotData, favoriteUIDs.indexOf(spotData.UID)>=0)
                );
            });
        }


        function renderCard(spotData, isFavorite) {
            return $('<div>').addClass('card').append(
                $('<div>').addClass('title').text(spotData.masterUnit[0]),
                $('<div>').addClass('name').text(spotData.title),
                spotData.imageUrl ? $('<img>').attr("src", spotData.imageUrl) : null,
                $('<div>').addClass('desc').html(spotData.descriptionFilterHtml),
                $('<div>').addClass('category').text("活動類別：" + spotData.category),
                $('<div>').addClass('favoriteBtn').append(
                    $('<img>').attr('src', isFavorite ? '/favorite-icon-14.jpeg' : './favorite-icon-13.jpeg')
                        .addClass(isFavorite ? "show" : "")
                        .on('click', (e) => {
                            e.stopPropagation();
                            if ($(e.currentTarget).hasClass('show')) {//取消最愛
                                $(e.currentTarget).removeClass('show').attr('src', '/favorite-icon-13.jpeg');
                                favoriteArray = favoriteArray.filter(data => data.UID != spotData.UID);
                                if(_isFavoriteMode){
                                    showFavoriteView();
                                }
                            } else {//加入最愛
                                $(e.currentTarget).addClass('show').attr('src', '/favorite-icon-14.jpeg');
                                if (favoriteArray.indexOf(spotData) < 0) {
                                    favoriteArray.push(spotData);
                                }
                            }
                        })
                )
            ).on("click", () => {
                location.href = spotData.sourceWebPromote
            })
        }

        function renderCategoryMenu() {
            let $menu = $('.categoryMenu');
            Object.keys(CategoryTypes).forEach(category => {
                $menu.append(
                    $('<div>').addClass('menuItem').text(category).on("click", () => {
                        _category = CategoryTypes[category];
                        refreshView();
                    })
                );
            });
            $menu.hide();
            bindBtnEvent($menu);
        }

        function bindBtnEvent($menu){
            $(".selectCategory").on("click", () => {
                if ($menu.is(":visible")) {
                    $menu.fadeOut();
                    return;
                }
                _isFavoriteMode = false;              
                $menu.fadeIn();
            });

            $('.myFavorite').on("click", () => {
                _isFavoriteMode = true;  

                showFavoriteView();

            })
        }

        window.addEventListener("load", () => {
            setFavoriteFromLocalStorage();
            refreshView();
            renderCategoryMenu();

        });

        window.addEventListener("beforeunload",()=>{
            saveFavoriteToLocalStorage();
        })
    </script>
</body>

</html>